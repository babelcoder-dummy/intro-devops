# version: "3.9"
# services:
#   site:
#     build:
#       context: ./site
#       dockerfile: Dockerfile
#     env_file:
#       - ./site/.env
#     ports:
#       - 5151:80
#   api:
#     build:
#       context: ./api
#       dockerfile: Dockerfile
#     ports:
#       - 5152:3000
#     environment:
#       - DATABASE_URL=redis://db:6379
#       - PORT=3000
#       - APP_ENV=production
#   db:
#     image: redis:7.2.4-alpine
#     ports:
#       - 6379:6379

version: "3.9"
services:
  site:
    image: babelcoder/intro-to-devops-ui:1.0
    ports:
      - 5151:80
    labels:
      com.datadoghq.ad.check_names: '["site"]'
      com.datadoghq.ad.init_configs: "[{}]"
      com.datadoghq.ad.instances: '[{"host":"%%host%%", "port": "%%port%%"}]'
      com.datadoghq.ad.logs: '[{"source": "go", "service": "go"}]'
      com.datadoghq.tags.env: "prod"
      com.datadoghq.tags.service: "site"
      com.datadoghq.tags.version: "1.0"
    depends_on:
      - datadog
      - db
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    ports:
      - 5152:3000
    environment:
      - DATABASE_URL=redis://db:6379
      - PORT=3000
      - APP_ENV=production
      - DD_SERVICE=api
      - DD_ENV=prod
      - DD_VERSION=1.0
      - DD_AGENT_HOST=datadog
    labels:
      com.datadoghq.ad.check_names: '["api"]'
      com.datadoghq.ad.init_configs: "[{}]"
      com.datadoghq.ad.instances: '[{"host":"%%host%%", "port": "%%port%%"}]'
      com.datadoghq.ad.logs: '[{"source": "go", "service": "go"}]'
      com.datadoghq.tags.env: "prod"
      com.datadoghq.tags.service: "api"
      com.datadoghq.tags.version: "1.0"
    depends_on:
      - datadog
  db:
    image: redis:7.2.4-alpine
    ports:
      - 6379:6379
  kong:
    image: kong:3.3.1-alpine
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /user/local/kong/declarative/kong.yml
      KONG_PROXY_LISTEN: 0.0.0.0:8000
    ports:
      - 8000:8000
    volumes:
      - "./kong:/user/local/kong/declarative"
  datadog:
    image: gcr.io/datadoghq/agent:7
    restart: always
    environment:
      - DD_API_KEY=c81908029334047c071e4e2148c42151
      - DD_SITE=ap1.datadoghq.com
      - DD_HOSTNAME=datadog
      - DD_APM_ENABLED=true
      - DD_APM_NON_LOCAL_TRAFFIC=true
      # - DD_APM_RECEIVER_SOCKET=/opt/datadog/apm/inject/run/apm.socket
      - DD_LOGS_ENABLED=true
      - DD_LOGS_CONFIG_CONTAINER_COLLECT_ALL=true
      # - DD_DOGSTATSD_NON_LOCAL_TRAFFIC=true
      - DD_CONTAINER_EXCLUDE=image:gcr.io/datadoghq/agent*
      - DD_CONTAINER_EXCLUDE_METRICS=image:gcr.io/datadoghq/agent*
      - DD_CONTAINER_EXCLUDE_LOGS=image:gcr.io/datadoghq/agent*
      - DD_DOGSTATSD_SOCKET=/opt/datadog/apm/inject/run/dsd.socket
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      # - /proc/:/host/proc/:ro
      # - /sys/fs/cgroup/:/host/sys/fs/cgroup:ro
      - \\.\pipe\docker_engine:\\.\pipe\docker_engine
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
